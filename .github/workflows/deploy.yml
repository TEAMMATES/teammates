name: Deploy TEAMMATES Staging

on:
  push:
    branches: [ V9-clean-slate-sql-staging-cd ]

permissions:
  contents: read
  id-token: write   # required for OIDC

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install frontend dependencies
        run: npm ci

      - name: Create config files
        run: ./gradlew createConfigs
      
      - name: Configure build.properties
        env:
          APP_ID: ${{ vars.APP_ID }}
          APP_REGION: ${{ vars.APP_REGION }}
          APP_VERSION: ${{ vars.APP_VERSION }}
          APP_POSTGRES_HOST: ${{ vars.APP_POSTGRES_HOST }}
          APP_POSTGRES_PORT: ${{ vars.APP_POSTGRES_PORT }}
          APP_POSTGRES_DATABASENAME: ${{ vars.APP_POSTGRES_DATABASENAME }}
          APP_POSTGRES_PASSWORD: ${{ secrets.APP_POSTGRES_PASSWORD }}
          APP_PRODUCTION_GCS_BUCKETNAME: ${{ vars.APP_PRODUCTION_GCS_BUCKETNAME }}
          APP_BACKUP_KEY: ${{ secrets.APP_BACKUP_KEY }}
          APP_CAPTCHA_SECRET_KEY: ${{ secrets.APP_CAPTCHA_SECRET_KEY }}
          APP_CSRF_KEY: ${{ secrets.APP_CSRF_KEY }}
          APP_ENCRYPTION_KEY: ${{ secrets.APP_ENCRYPTION_KEY }}
          APP_OAUTH2_CLIENT_ID: ${{ secrets.APP_OAUTH2_CLIENT_ID }}
          APP_OAUTH2_CLIENT_SECRET: ${{ secrets.APP_OAUTH2_CLIENT_SECRET }}
          APP_ADMINS: ${{ vars.APP_ADMINS }}
          APP_CRASHREPORT_EMAIL: ${{ vars.APP_CRASHREPORT_EMAIL }}
          APP_EMAIL_REPLYTO: ${{ vars.APP_EMAIL_REPLYTO }}
          APP_EMAIL_SENDEREMAIL: ${{ vars.APP_EMAIL_SENDEREMAIL }}
          APP_EMAIL_SENDERNAME: ${{ vars.APP_EMAIL_SENDERNAME }}
          APP_MAINTAINERS: ${{ vars.APP_MAINTAINERS }}
          APP_SEARCH_SERVICE_HOST: ${{ vars.APP_SEARCH_SERVICE_HOST }}
        run: |
          cat > src/main/resources/build.properties << EOF
          app.id=${APP_ID}
          app.region=${APP_REGION}
          app.version=${APP_VERSION}
          
          app.postgres.host=${APP_POSTGRES_HOST}
          app.postgres.port=${APP_POSTGRES_PORT}
          app.postgres.databasename=${APP_POSTGRES_DATABASENAME}
          app.postgres.username=postgres
          app.postgres.password=${APP_POSTGRES_PASSWORD}
          
          app.production.gcs.bucketname=${APP_PRODUCTION_GCS_BUCKETNAME}
          app.backup.gcs.bucketname=${APP_PRODUCTION_GCS_BUCKETNAME}
          
          app.enable.datastore.backup=false
          app.maintenance=false
          
          app.csrf.key=${APP_CSRF_KEY}
          app.backdoor.key=${APP_BACKUP_KEY}
          app.encryption.key=${APP_ENCRYPTION_KEY}
          
          app.auth.type=googleoauth2
          app.oauth2.client.id=${APP_OAUTH2_CLIENT_ID}
          app.oauth2.client.secret=${APP_OAUTH2_CLIENT_SECRET}
          
          app.captcha.secretkey=${APP_CAPTCHA_SECRET_KEY}
          
          app.admins=${APP_ADMINS}
          app.maintainers=${APP_MAINTAINERS}
          app.crashreport.email=${APP_CRASHREPORT_EMAIL}
          
          app.email.senderemail=${APP_EMAIL_SENDEREMAIL}
          app.email.sendername=${APP_EMAIL_SENDERNAME}
          app.email.replyto=${APP_EMAIL_REPLYTO}
          app.email.service=
          
          app.search.service.host=${APP_SEARCH_SERVICE_HOST}
          EOF
      
      - name: Compile type definitions
        run: ./gradlew generateTypes

      - name: Build frontend
        run: npm run build
      
      # üîê OIDC Authentication (no service account key)
      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          create_credentials_file: true
          workload_identity_provider: >-
            projects/${{ vars.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ vars.GCP_WIF_POOL_ID }}/providers/${{ vars.GCP_WIF_PROVIDER_ID }}
          service_account: "github-cd@teammates-staging-487205.iam.gserviceaccount.com"
      
      - name: Error Handling
        run: |
          echo "Checking project status..."
          gcloud projects describe ${{ vars.APP_ID }} || echo "‚ùå Project not found or inaccessible"
          
          echo "Checking App Engine status..."
          gcloud app describe --project=${{ vars.APP_ID }} || echo "‚ùå App Engine not accessible"

      - name: Deploy to App Engine
        run: ./gradlew appengineDeployAll
